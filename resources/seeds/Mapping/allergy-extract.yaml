resourceType: Mapping
id: allergy-extract
type: FHIRPath
body:
    "{% assign %}":
    - qrId: "{{ %QuestionnaireResponse.id }}"
    - qrVersion: "{{ %QuestionnaireResponse.meta.versionId }}"
    - qrLastUpdated:
        "{% if %QuestionnaireResponse.meta.lastUpdated.exists() %}":
        - "{{ %QuestionnaireResponse.meta.lastUpdated }}"
        "{% else %}":
        - "{{ %QuestionnaireResponse.answers(linkId='dateTime') }}"
    - allergyIntoleranceId: "{{ %Provenance.target.reference.split('AllergyIntolerance/')[1] }}"
    - author: "{{ %Author }}"
    - status: "{{ %QuestionnaireResponse.answers('status') }}"
    - patientId: "{{ %QuestionnaireResponse.answers('patientId') }}"
    - patientName: "{{ %QuestionnaireResponse.answers('patientName') }}"
    - category: "{{ QuestionnaireResponse.answers('type') }}"
    - reactions: "{[ QuestionnaireResponse.answers('reaction') ]}"
    - notes: "{{ QuestionnaireResponse.answers('notes') }}"
    - substanceDrug: "{{ QuestionnaireResponse.answers('substance-drug') }}"
    - substanceFood: "{{ QuestionnaireResponse.answers('substance-food') }}"
    - substanceEnvironmental: "{{ QuestionnaireResponse.answers('substance-environmental') }}"
    resourceType: "Bundle"
    type: transaction
    entry:
    - request:
        "{% if %allergyIntoleranceId.exists() %}":
          url: "/AllergyIntolerance/{{ %allergyIntoleranceId }}"
          method: PUT
        "{% else %}":
          url: /AllergyIntolerance
          method: POST
      fullUrl: urn:uuid:allergy-id
      resource:
        resourceType: AllergyIntolerance
        recordedDate: "{{ %qrLastUpdated }}"
        clinicalStatus:
          coding:
          - "{{ %status }}"
        verificationStatus:
          coding:
          - code: 'confirmed'
            display: 'Confirmed'
            system: 'http://terminology.hl7.org/CodeSystem/allergyintolerance-verification'
        patient:
          reference: "Patient/{{ %patientId }}"
          display: "{{ %patientName }}"
        category:
        - "{{ %category.code }}"
        code:
          coding:
            "{% if %substanceDrug.exists() %}":
              - "{{ %substanceDrug }}"
            "{% else %}":
              "{% if %substanceFood.exists() %}":
                - "{{ %substanceFood }}"
              "{% else %}":
                - "{{ %substanceEnvironmental }}"
        reaction:
        - substance:
            coding:
              "{% if %substanceDrug.exists() %}":
                - "{{ %substanceDrug }}"
              "{% else %}":
                "{% if %substanceFood.exists() %}":
                  - "{{ %substanceFood }}"
                "{% else %}":
                  - "{{ %substanceEnvironmental }}"
          "{% if %reactions.exists() %}":
            manifestation:
              "{% for reaction in %reactions %}":
                coding:
                - "{{ %reaction }}"
        "{% if %notes.exists() %}":
          note:
          - text: "{{ %notes }}"
    - request:
        url: /Provenance
        method: POST
      resource:
        resourceType: Provenance
        target:
          - uri: urn:uuid:allergy-id
        recorded: "{{ %qrLastUpdated }}"
        activity:
          "{% if %allergyIntoleranceId.exists() %}":
            coding:
            - code: 'UPDATE'
              display: 'revise'
              system: 'http://terminology.hl7.org/CodeSystem/v3-DataOperation'
          "{% else %}":
            coding:
            - code: 'CREATE'
              display: 'create'
              system: 'http://terminology.hl7.org/CodeSystem/v3-DataOperation'
        agent:
        - who:
            reference: "{{ %author.resourceType }}/{{ %author.id }}"
            "{% if %author.resourceType = 'Organization' %}":
              display: "{{ %author.name }}"
            "{% else %}":
              display: "{{ %author.name.given.first() + ' ' + %author.name.family.first() }}"
        entity:
        - role: source
          what:
            uri: "QuestionnaireResponse/{{ %qrId }}/_history/{{ %qrVersion }}"
