type: FHIRPath
resourceType: Mapping
body:
  type: transaction
  entry:
  - request:
      url: "ServiceRequest"
      method: POST
    resource:
      status: 'active'
      identifier:
      - type:
          text: "Placer Group Number"
          coding:
          - code: PGN
            system: http://terminology.hl7.org/CodeSystem/v2-0203
        system: http://diagnostic-orders-are-us.com.au/ids/pgn
        value: "{{ QuestionnaireResponse.repeat(item).where(linkId='barcode').answer.valueString }}"
      category:
      - "{% if QuestionnaireResponse.repeat(item).where(linkId='type').answer.valueString = 'Pathology' %}":
          coding:
          - code: '108252007'
            display: 'Laboratory procedure'
            system: 'http://snomed.info/sct'
        "{% else %}":
          coding:
          - code: '363679005'
            display: 'Radiology procedure'
            system: 'http://snomed.info/sct'
      code:
        text: "{{ QuestionnaireResponse.repeat(item).select(where(linkId='test-code-pathology')|where(linkId='test-core-radiology')).answer.valueCoding.display }}"
        coding:
        - "{{ QuestionnaireResponse.repeat(item).select(where(linkId='test-code-pathology')|where(linkId='test-core-radiology')).answer.valueCoding }}"
      intent: "order"
      priority: "{{ QuestionnaireResponse.repeat(item).where(linkId='priority').answer.valueCoding.code }}"
      encounter:
        reference: "{{ 'Encounter/' + QuestionnaireResponse.repeat(item).where(linkId='encounter-id').answer.valueString }}"
      requester:
        reference: "{{ 'Practitioner/' + QuestionnaireResponse.repeat(item).where(linkId='practitiner-id').answer.valueString }}"
      subject:
        reference: "{{ 'Patient/' + QuestionnaireResponse.repeat(item).where(linkId='patient-id').answer.valueString }}"
      performer:
      - reference: "{{ QuestionnaireResponse.repeat(item).select(where(linkId='assigned-organization-pathology')|where(linkId='assigned-organization-radiology')).answer.valueReference.reference }}"
