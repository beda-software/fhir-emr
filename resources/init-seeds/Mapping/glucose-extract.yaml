resourceType: Mapping
id: glucose-extract
type: FHIRPath
body:
  "{% assign %}":
    - qrId: "{{ %QuestionnaireResponse.id }}"
    - qrVersion: "{{ %QuestionnaireResponse.meta.versionId }}"
    - qrLastUpdated: "{{ iif(%QuestionnaireResponse.meta.lastUpdated.exists(), %QuestionnaireResponse.meta.lastUpdated, %QuestionnaireResponse.answers('dateTime')) }}"
    - observationId:
        "{% if %ProvenanceBundle.entry.count() > 0 %}": "{{ %Provenance.target.where(resourceType='Observation').id }}"
    - patientId: "{{ %QuestionnaireResponse.answers('patientId') }}"
    - patientName: "{{ %QuestionnaireResponse.answers('patientName') }}"
    - glucose: "{{ %QuestionnaireResponse.answers('glucose-level') }}"
    - dateTime: "{{ %QuestionnaireResponse.answers('dateTime') }}"
    - orderNumber: "{{ %QuestionnaireResponse.answers('order-number') }}"
    - laboratory: "{{ %QuestionnaireResponse.answers('laboratory') }}"
    - author: "{{ %Author }}"

  resourceType: Bundle
  type: transaction
  entry:
    - request:
        "{% if %observationId.exists() %}":
          url: "/Observation/{{ %observationId }}"
          method: PUT
        "{% else %}":
          url: /Observation
          method: POST
      fullUrl: "urn:uuid:observation-id"
      resource:
        resourceType: Observation
        status: final
        category:
          - coding:
              - system: "http://terminology.hl7.org/CodeSystem/observation-category"
                code: laboratory
        code:
          coding:
            - system: "http://loinc.org"
              code: "15074-8"
              display: "Glucose [Moles/volume] in Blood"
        subject:
          reference: "Patient/{{ %patientId }}"
          display: "{{ %patientName }}"
        effectiveDateTime: "{{ %dateTime }}"
        valueQuantity:
          value: "{{ %glucose }}"
          unit: "mmol/L"
          system: "http://unitsofmeasure.org"
          code: "mmol/L"

        "{% merge %}":
          - "{% if %orderNumber.exists() and %orderNumber != '' %}":
              identifier:
                - system: "http://beda.software/lab-order-number"
                  value: "{{ %orderNumber }}"

          - "{% if %laboratory.exists() %}":
              performer:
                - display: "{{ %laboratory.display }}"
                  "{% merge %}":
                    - "{% if %laboratory.system.exists() or %laboratory.code.exists() %}":
                        identifier:
                          system: "{{ iif(%laboratory.system.exists(), %laboratory.system, 'http://beda.software/lab-code') }}"
                          value: "{{ %laboratory.code }}"

    - request:
        url: /Provenance
        method: POST
      resource:
        resourceType: Provenance
        target:
          - reference: "urn:uuid:observation-id"
        recorded: "{{ iif(%qrLastUpdated.exists(), %qrLastUpdated, now()) }}"
        activity:
          coding:
            - system: "http://terminology.hl7.org/CodeSystem/v3-DataOperation"
              code: "CREATE"
              display: "create"

        "{% merge %}":
          - "{% if %author.exists() %}":
              agent:
                - who:
                    reference: "{{ %author.resourceType }}/{{ %author.id }}"
                    "{% merge %}":
                      - "{% if %author.resourceType = 'Organization' and %author.name.exists() %}":
                          display: "{{ %author.name }}"
                      - "{% if %author.resourceType != 'Organization' and %author.name.first().given.first().exists() and %author.name.first().family.exists() %}":
                          display: "{{ %author.name.first().given.first() + ' ' + %author.name.first().family }}"

          - "{% if %qrId.exists() %}":
              entity:
                - role: source
                  what:
                    reference: "{{ 'QuestionnaireResponse/' + %qrId + iif(%qrVersion.exists(), '/_history/' + %qrVersion, '') }}"
