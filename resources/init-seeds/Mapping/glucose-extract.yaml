body:
  $let:
    qrId: $ fhirpath("QuestionnaireResponse.id")
    qrVersion: $ fhirpath("QuestionnaireResponse.meta.versionId")
    qrLastUpdated: >-
      $ fhirpath("QuestionnaireResponse.meta.lastUpdated") || fhirpath("QuestionnaireResponse.repeat(item).where(linkId='dateTime').answer.valueDateTime").0
    observationId: $ fhirpath("Provenance.target.where(resourceType='Observation').id").0
    author: $ Author
    patientId: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientId').answer.valueString").0
    patientName: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='patientName').answer.valueString").0
    glucose: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='glucose-level').answer.valueDecimal").0
    dateTime: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='dateTime').answer.valueDateTime").0
  $body:
    resourceType: Bundle
    type: transaction
    entry:
      - request:
          $if: $ observationId
          $then:
            url: $ "/Observation/" + observationId
            method: PUT
          $else:
            url: /Observation
            method: POST
        fullUrl: $ "urn:uuid:immunization-id"
        resource:
          status: final
          category:
            - coding:
                - system: "http://terminology.hl7.org/CodeSystem/observation-category"
                  code: "laboratory"
          code:
            coding:
              - system: "http://loinc.org"
                code: "15074-8"
                display: "Glucose [Moles/volume] in Blood"
          subject:
            reference: $ "Patient/" + patientId
            display: $ patientName
          effective:
            dateTime: $ dateTime
          value:
            Quantity:
              value: $ glucose
              unit: "mmol/L"
              system: "http://unitsofmeasure.org"
              code: "mmol/L"
          resourceType: Observation
      - request:
          url: /Provenance
          method: POST
        resource:
          resourceType: Provenance
          target:
            - uri: $ "urn:uuid:immunization-id"
          recorded: $ qrLastUpdated
          activity:
            $if: $ observationId
            $then:
              coding:
                - code: "UPDATE"
                  display: "revise"
                  system: "http://terminology.hl7.org/CodeSystem/v3-DataOperation"
            $else:
              coding:
                - code: "CREATE"
                  display: "create"
                  system: "http://terminology.hl7.org/CodeSystem/v3-DataOperation"
          agent:
            - who:
                reference: $ author.resourceType + "/" + author.id
                display:
                  $switch: $ author.resourceType
                  Organization: $ author.name
                  $default: $ author.name.0.given.0 + " " + author.name.0.family
          entity:
            - role: source
              what:
                uri: $ "QuestionnaireResponse/" + qrId + "/_history/" + qrVersion
id: immunization-extract
resourceType: Mapping
