resourceType: Mapping
id: labs
type: FHIRPath
body:
  "{% assign %}":
    - patientId: "{{ %QuestionnaireResponse.answers('patientId') }}"
    - patientName: "{{ %QuestionnaireResponse.answers('patientName') }}"
    - encounterId: "{{ %Encounter.id }}"
    - il6: "{{ %QuestionnaireResponse.answers('il6') }}"
    - crp: "{{ %QuestionnaireResponse.answers('crp') }}"

  resourceType: Bundle
  type: transaction
  entry:
    - "{% if %il6.exists() %}":
        request:
          method: POST
          url: /Observation
        resource:
          resourceType: Observation
          status: final
          category:
            - coding:
                - system: "http://terminology.hl7.org/CodeSystem/observation-category"
                  code: "laboratory"
          code:
            coding:
              - system: "http://loinc.org"
                code: "LP16474-6"
                display: "IL-6"
          subject:
            reference: "Patient/{{ %patientId }}"
            display: "{{ %patientName }}"
          encounter:
            reference: "Encounter/{{ %encounterId }}"
          effectiveDateTime: "{{ now() }}"
          valueQuantity:
            value: "{{ %il6 }}"
            unit: "pg/ml"
            system: "http://unitsofmeasure.org"
            code: "pg/ml"

    - "{% if %crp.exists() %}":
        request:
          method: POST
          url: /Observation
        resource:
          resourceType: Observation
          status: final
          category:
            - coding:
                - system: "http://terminology.hl7.org/CodeSystem/observation-category"
                  code: "laboratory"
          code:
            coding:
              - system: "http://loinc.org"
                code: "1988-5"
                display: "CRP"
          subject:
            reference: "Patient/{{ %patientId }}"
            display: "{{ %patientName }}"
          encounter:
            reference: "Encounter/{{ %encounterId }}"
          effectiveDateTime: "{{ now() }}"
          valueQuantity:
            value: "{{ %crp }}"
            unit: "pg/ml"
            system: "http://unitsofmeasure.org"
            code: "pg/ml"
