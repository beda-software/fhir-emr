resourceType: Mapping
id: healthcare-service-create-extract
type: FHIRPath
body:
  "{% assign %}":
    - duration: "{{ %QuestionnaireResponse.answers('duration') }}"
    - visitTypeCode: "{{ %QuestionnaireResponse.answers('visit-type-code') }}"
    - visitTypeName: "{{ %QuestionnaireResponse.answers('visit-type-name') }}"
    - comment: "{{ %QuestionnaireResponse.answers('comment') }}"
    - priceBase: "{{ %QuestionnaireResponse.answers('price-base') }}"
    - priceTax: "{{ %QuestionnaireResponse.answers('price-tax') }}"

  resourceType: Bundle
  type: transaction
  entry:
    - request:
        method: POST
        url: /HealthcareService
      fullUrl: "urn:uuid:healthcare-service-id"
      resource:
        resourceType: HealthcareService
        name: "{{ %visitTypeName }}"
        comment: "{{ %comment }}"
        type:
          - text: "{{ %visitTypeName }}"
            coding:
              - system: "http://beda.software/custom-healthcare-service-list"
                code: "{{ %visitTypeCode }}"
                display: "{{ %visitTypeName }}"
        extension:
          - url: "urn:extensions:healthcare-service-duration"
            valueInteger: "{{ %duration }}"
        active: true
        appointmentRequired: true
        meta:
          profile:
            - "https://beda.software/beda-emr-healthcare-service"

    - request:
        method: POST
        url: /ChargeItemDefinition
      fullUrl: "urn:uuid:charge-item-definition-id"
      resource:
        resourceType: ChargeItemDefinition
        url: "https://emr.beda.software/charge-item/{{ %visitTypeCode }}"
        status: active
        title: "{{ %visitTypeName }}"
        propertyGroup:
          - priceComponent:
              - "{% if %priceBase.exists() %}":
                  type: base
                  amount:
                    value: "{{ %priceBase }}"
                    currency: USD
              - "{% if %priceTax.exists() %}":
                  type: tax
                  amount:
                    value: "{{ %priceTax }}"
                    currency: USD
        extension:
          - url: "http://beda.software/fhir-extensions/charge-item-healthcare-service"
            valueReference:
              reference: "urn:uuid:healthcare-service-id"
        meta:
          profile:
            - "https://beda.software/beda-emr-charge-item-definition"
