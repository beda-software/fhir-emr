id: data-sharing-consent-extract
resourceType: Mapping
type: FHIRPath
body:
  "{% assign %}":
    - qrId: "{{ %QuestionnaireResponse.id }}"
    - qrVersion: "{{ %QuestionnaireResponse.meta.versionId }}"
    - qrLastUpdated: "{{ %QuestionnaireResponse.meta.lastUpdated }}"
    - consentID: "{{ iif(%ProvenanceBundle.resource.entry.count() > 0, %ProvenanceBundle.resource.entry.target.where(resourceType='Consent').id, false) }}"
    - practitioner: "{{ %QuestionnaireResponse.answers('practitioner') }}"
    - provision: "{{ %QuestionnaireResponse.answers('provision') }}"
    - dateStart: "{{ %QuestionnaireResponse.answers('date-start') }}"
    - dateEnd: "{{ %QuestionnaireResponse.answers('date-end') }}"
    - patientRef: "{{ 'Patient/' + %Patient.id }}"
    - patientDisplay: "{{ %Patient.name.given.first() + ' ' + %Patient.name.family }}"
    - authorRef: "{{ %Author.resourceType + '/' + %Author.id }}"
    - authorDisplay: "{{ iif(%Author.resourceType = 'Organization', %Author.name, %Author.name.given.first() + ' ' + %Author.name.family) }}"

  resourceType: Bundle
  type: transaction
  entry:
    - fullUrl: "urn:uuid:consent-id"
      request:
        "{% if %consentID.exists() and %consentID %}":
          url: "{{ '/Consent/' + %consentID }}"
          method: PATCH
        "{% else %}":
          url: "/Consent"
          method: POST
      resource:
        resourceType: Consent
        status: "{{ iif(%provision.code = 'permit', 'active', 'inactive') }}"
        patient:
          reference: "{{ %patientRef }}"
          display: "{{ %patientDisplay }}"
        scope:
          coding:
            - system: "http://terminology.hl7.org/CodeSystem/consentscope"
              code: patient-privacy
        performer:
          - reference: "{{ %authorRef }}"
            display: "{{ %authorDisplay }}"
        sourceReference:
          reference: "{{ 'QuestionnaireResponse/' + %qrId }}"
        category:
          - coding:
              - system: "http://terminology.hl7.org/CodeSystem/v3-ActCode"
                code: data-sharing
        policy:
          - uri: "https://tribecapediatrics.com/policy/demographic-clinical-data-sharing"
        provision:
          type: "{{ %provision.code }}"
          period:
            start: "{{ %dateStart }}"
            end: "{{ %dateEnd }}"
          actor:
            - role:
                coding:
                  - system: "http://terminology.hl7.org/CodeSystem/v3-RoleClass"
                    code: PROV
              reference:
                resourceType: "{{ %practitioner.reference.split('/')[0] }}"
                id: "{{ %practitioner.reference.split('/')[1] }}"
          action:
            - coding:
                - system: "http://terminology.hl7.org/CodeSystem/consentaction"
                  code: access
          purpose:
            - system: "http://terminology.hl7.org/CodeSystem/v3-ActReason"
              code: CAREMGT
              display: care management

    - request:
        url: /Provenance
        method: POST
      resource:
        resourceType: Provenance
        target:
          - uri: "{{ 'urn:uuid:consent-id' }}"
        recorded: "{{ iif(%qrLastUpdated.exists(), %qrLastUpdated, now()) }}"
        agent:
          - who:
              reference: "{{ %authorRef }}"
              display: "{{ %authorDisplay }}"
        "{% merge %}":
          - "{% if %qrId.exists() %}":
              entity:
                - role: source
                  what:
                    uri: "QuestionnaireResponse/{{ %qrId }}{{ iif(%qrVersion.exists(), '/_history/' + %qrVersion, '') }}"
        activity:
          "{% if %consentID.exists() %}":
            coding:
              - system: "http://terminology.hl7.org/CodeSystem/v3-DataOperation"
                code: UPDATE
                display: revise
          "{% else %}":
            coding:
              - system: "http://terminology.hl7.org/CodeSystem/v3-DataOperation"
                code: CREATE
                display: create
