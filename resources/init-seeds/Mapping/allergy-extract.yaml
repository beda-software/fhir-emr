id: allergy-extract
resourceType: Mapping
type: FHIRPath
body:
  "{% assign %}":
    - qrId: "{{ %QuestionnaireResponse.id }}"
    - qrVersion: "{{ %QuestionnaireResponse.meta.versionId }}"
    - qrLastUpdated: "{{ iif(%QuestionnaireResponse.meta.lastUpdated.exists(), %QuestionnaireResponse.meta.lastUpdated, %QuestionnaireResponse.answers('dateTime')) }}"
    - allergyIntoleranceId: "{{ %Provenance.target.where(resourceType='AllergyIntolerance').id }}"
    - author: "{{ %Author }}"
    - status: "{{ %QuestionnaireResponse.answers('status') }}"
    - patientId: "{{ %QuestionnaireResponse.answers('patientId') }}"
    - patientName: "{{ %QuestionnaireResponse.answers('patientName') }}"
    - category: "{{ %QuestionnaireResponse.answers('type').code }}"
    - reaction: "{[ %QuestionnaireResponse.answers('reaction') ]}"
    - notes: "{{ %QuestionnaireResponse.answers('notes') }}"
    - substanceDrug: "{{ %QuestionnaireResponse.answers('substance-drug') }}"
    - substanceFood: "{{ %QuestionnaireResponse.answers('substance-food') }}"
    - substanceEnvironmental: "{{ %QuestionnaireResponse.answers('substance-environmental') }}"
    - substance: "{{ (%substanceDrug | %substanceFood | %substanceEnvironmental).first() }}"

  resourceType: Bundle
  type: transaction
  entry:
    - request:
        "{% if %allergyIntoleranceId.exists() %}":
          url: "/AllergyIntolerance/{{ %allergyIntoleranceId }}"
          method: PUT
        "{% else %}":
          url: /AllergyIntolerance
          method: POST
      fullUrl: "{{'urn:uuid:allergy-id'}}"
      resource:
        resourceType: AllergyIntolerance
        recordedDate: "{{ %qrLastUpdated }}"
        clinicalStatus:
          coding:
            - "{{ %status }}"
        verificationStatus:
          coding:
            - code: "confirmed"
              display: "Confirmed"
              system: "http://terminology.hl7.org/CodeSystem/allergyintolerance-verification"
        patient:
          reference: "{{ 'Patient/' + %patientId }}"
          display: "{{ %patientName }}"
        category:
          - "{{ %category }}"
        code:
          "{% if %substance.exists() %}":
            coding:
              - "{{ %substance }}"
        reaction:
          - "{% if %reaction.exists() %}":
              manifestation:
                - "{% for reactionItem in %reaction %}":
                    coding:
                      - "{{ %reactionItem }}"
              substance:
                "{% if %substance.exists() %}":
                  coding:
                    - "{{ %substance }}"
        note:
          - text: "{{ %notes }}"
    - request:
        url: /Provenance
        method: POST
      resource:
        resourceType: Provenance
        target:
          - uri: "{{ 'urn:uuid:allergy-id' }}"
        recorded: "{{ %qrLastUpdated }}"
        activity:
          "{% if %allergyIntoleranceId.exists() %}":
            coding:
              - code: "UPDATE"
                display: "revise"
                system: "http://terminology.hl7.org/CodeSystem/v3-DataOperation"
          "{% else %}":
            coding:
              - code: "CREATE"
                display: "create"
                system: "http://terminology.hl7.org/CodeSystem/v3-DataOperation"
        agent:
          - who:
              reference: "{{ %author.resourceType }}/{{ %author.id }}"
              "{% if %author.resourceType = 'Organization' %}":
                display: "{{ %author.name }}"
              "{% else %}":
                display: "{{ %author.name.first().given.first() + ' ' + %author.name.first().family }}"
        "{% if %qrId.exists() and %qrVersion.exists() %}":
          entity:
            - role: source
              what:
                uri: "{{ 'QuestionnaireResponse/' + %qrId + '/_history/' + %qrVersion }}"
