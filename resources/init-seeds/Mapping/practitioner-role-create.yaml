resourceType: Mapping
id: practitioner-role-create
type: FHIRPath
body:
  "{% assign %}":
    - organization: "{{ %QuestionnaireResponse.answers('organization') }}"
    - practitioner: "{{ %QuestionnaireResponse.answers('practitioner') }}"
    - specialty: "{{ %QuestionnaireResponse.answers('specialty') }}"
    - orgRef: "{{ iif(%organization.startsWith('Organization/'), %organization, 'Organization/' + %organization) }}"
    - pracRef: "{{ iif(%practitioner.startsWith('Practitioner/'), %practitioner, 'Practitioner/' + %practitioner) }}"

  resourceType: Bundle
  type: transaction
  entry:
    - "{% if %organization.exists() and %organization!='' %}":
        request:
          method: PUT
          url: "/{{ %orgRef }}"
        resource:
          resourceType: Organization
          name: "{{ %organization }}"
          active: true

    - "{% if %practitioner.exists() and %practitioner!='' %}":
        request:
          method: PUT
          url: "/{{ %pracRef }}"
        resource:
          resourceType: Practitioner
          active: true

    - request:
        method: POST
        url: /PractitionerRole
      resource:
        resourceType: PractitionerRole
        active: true
        organization:
          reference: "{{ %orgRef }}"
        practitioner:
          reference: "{{ %pracRef }}"
        specialty:
          - coding:
              - system: "http://snomed.info/sct"
                code: "{{ %specialty }}"
                display: "{{ %specialty }}"
