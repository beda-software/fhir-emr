resourceType: Mapping
id: medication-request-extract
type: FHIRPath
body:
  "{% assign %}":
    - author: "{{ %Author }}"
    - patient: "{{ %Patient }}"
    - medicationRef: "{{ %QuestionnaireResponse.answers('medication') }}"

  resourceType: Bundle
  type: transaction
  entry:
    - request:
        method: PATCH
        url: "/{{ %medicationRef.reference }}"
      resource:
        status: inactive
    - fullUrl: "{{ 'urn:uuid:medication-request-id' }}"
      request:
        method: POST
        url: /MedicationRequest
      resource:
        resourceType: MedicationRequest
        status: active
        intent: plan
        requester:
          reference: "{{ %author.resourceType }}/{{ %author.id }}"
          display: "{{ iif(%author.resourceType='Organization', %author.name, %author.name[0].given[0] + ' ' + %author.name[0].family) }}"
        subject:
          reference: "Patient/{{ %patient.id }}"
          display: "{{ %patient.name[0].given[0] + ' ' + %patient.name[0].family }}"
        medication:
          Reference: "{{ %medicationRef }}"
