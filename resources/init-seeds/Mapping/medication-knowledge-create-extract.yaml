resourceType: Mapping
id: medication-knowledge-create-extract
type: FHIRPath
body:
  "{% assign %}":
    - code: "{{ %QuestionnaireResponse.answers('code') }}"
    - name: "{{ %QuestionnaireResponse.answers('name') }}"
    - doseForm: "{{ %QuestionnaireResponse.answers('dose-form') }}"
    - amountUnit: "{{ %QuestionnaireResponse.answers('amount-unit') }}"
    - amountValue: "{{ %QuestionnaireResponse.answers('amount-value') }}"
    - packagingType: "{{ %QuestionnaireResponse.answers('packaging-type') }}"
    - price: "{{ %QuestionnaireResponse.answers('price') }}"
    - ingredientsItems: "{[ %QuestionnaireResponse.repeat(item).where(linkId='ingredients') ]}"

  resourceType: Bundle
  type: transaction
  entry:
    - fullUrl: "{{ 'urn:uuid:medication-knowledge-id' }}"
      request:
        method: POST
        url: /MedicationKnowledge
      resource:
        resourceType: MedicationKnowledge
        status: active
        code:
          coding:
            - system: "http://beda.software/custom-medication-list"
              code: "{{ %code }}"
              display: "{{ %name }}"
        amount:
          system: "http://unitsofmeasure.org"
          code: "{{ %amountUnit.code }}"
          unit: "{{ %amountUnit.display }}"
          value: "{{ %amountValue }}"

        "{% merge %}":
          - "{% if %doseForm.exists() %}":
              doseForm:
                coding:
                  - "{{ %doseForm }}"
          - "{% if %packagingType.exists() %}":
              packaging:
                type:
                  coding:
                    - "{{ %packagingType }}"
          - "{% if %price.exists() %}":
              cost:
                - type:
                    coding:
                      - system: "http://terminology.hl7.org/CodeSystem/cost-type"
                        code: "wholesale"
                        display: "Wholesale Price"
                  cost:
                    value: "{{ %price }}"
                    currency: "USD"

          - "{% if %ingredientsItems.exists() and %ingredientsItems.count() > 0 %}":
              ingredient:
                - "{% for ingredient in %ingredientsItems %}":
                    item:
                      CodeableConcept:
                        coding:
                          - system: "http://www.nlm.nih.gov/research/umls/rxnorm"
                            code: "{{ %ingredient.item.where(linkId='ingredientsIngredient').answer.valueCoding.code }}"
                            display: "{{ %ingredient.item.where(linkId='ingredientsIngredient').answer.valueCoding.display }}"
                    isActive: true
                    strength:
                      numerator:
                        system: "http://unitsofmeasure.org"
                        code: "{{ %ingredient.item.where(linkId='numerator-unit').answer.valueCoding.code }}"
                        unit: "{{ %ingredient.item.where(linkId='numerator-unit').answer.valueCoding.display }}"
                        value: "{{ %ingredient.item.where(linkId='numerator-value').answer.valueDecimal }}"
                      denominator:
                        system: "http://unitsofmeasure.org"
                        code: "{{ %ingredient.item.where(linkId='denominator-unit').answer.valueCoding.code }}"
                        unit: "{{ %ingredient.item.where(linkId='denominator-unit').answer.valueCoding.display }}"
                        value: "{{ %ingredient.item.where(linkId='denominator-value').answer.valueDecimal }}"
