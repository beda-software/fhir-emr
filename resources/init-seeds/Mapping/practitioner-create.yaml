resourceType: Mapping
id: practitioner-create
type: FHIRPath
body:
  "{% assign %}":
    - firstName: "{{ %QuestionnaireResponse.answers('first-name') }}"
    - middleName: "{{ %QuestionnaireResponse.answers('middle-name') }}"
    - lastName: "{{ %QuestionnaireResponse.answers('last-name') }}"
    - specialties: "{[ %QuestionnaireResponse.repeat(item).where(linkId='specialty').answer.valueCoding ]}"
    - services: "{[ %QuestionnaireResponse.repeat(item).where(linkId='services').answer.valueReference ]}"

  resourceType: Bundle
  type: transaction
  entry:
    - fullUrl: "urn:uuid:practitioner-id"
      request:
        method: POST
        url: /Practitioner
      resource:
        resourceType: Practitioner
        active: true
        name:
          - family: "{{ %lastName  }}"
            given:
              - "{{ %firstName }}"
              - "{{ %middleName }}"

    - "{% for specialtyItem in %specialties %}":
        request:
          method: POST
          url: /PractitionerRole
        resource:
          resourceType: PractitionerRole
          code:
            - coding:
                - system: "http://terminology.hl7.org/CodeSystem/practitioner-role"
                  code: "doctor"
                  display: "Doctor"
          specialty:
            - coding:
                - "{{ %specialtyItem }}"
          practitioner:
            reference: "urn:uuid:practitioner-id"
          healthcareService:
            - "{% for serviceRef in %services %}": "{{ %serviceRef }}"
